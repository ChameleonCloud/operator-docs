
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../troubleshooting/" rel="prev"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.9" name="generator"/>
<title>Identity Federation - ChameleonCloud Ops Guide</title>
<link href="../../assets/stylesheets/main.4af4bdda.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#how-chameleons-identity-federation-works">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="ChameleonCloud Ops Guide" class="md-header__button md-logo" data-md-component="logo" href="../.." title="ChameleonCloud Ops Guide">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            ChameleonCloud Ops Guide
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Identity Federation
            
          </span>
</div>
</div>
</div>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="ChameleonCloud Ops Guide" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="ChameleonCloud Ops Guide">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    ChameleonCloud Ops Guide
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Readme
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ticketmaster/">
<span class="md-ellipsis">
    Ticketmaster
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../catchall/">
<span class="md-ellipsis">
    To Sort
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
<span class="md-ellipsis">
    Guides
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Guides
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../bios-changes/">
<span class="md-ellipsis">
    Change BIOS Settings
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../troubleshooting/">
<span class="md-ellipsis">
    Troubleshooting
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Identity Federation
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Identity Federation
    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#issues-with-account-linking">
<span class="md-ellipsis">
      Issues with Account Linking
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#references">
<span class="md-ellipsis">
      References
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#issues-with-account-linking">
<span class="md-ellipsis">
      Issues with Account Linking
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#references">
<span class="md-ellipsis">
      References
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="how-chameleons-identity-federation-works">How Chameleon's Identity Federation Works</h1>
<p>Chameleon uses Keycloak as the respository of chameleon-wide user accounts. However, we deletate authentication to Globus and/or TAS.</p>
<p>Additionally, on login to an openstack site, keycloak sends a token to keystone which contains the username and list of project memberships, which keystone maps into local ones.</p>
<p>Note: Globus itself is also an identity broker, and this process can be continued as far as desired.</p>
<div class="mermaid">sequenceDiagram
    participant User
    participant Keystone as Keystone (Service Provider)
    participant Keycloak as Keycloak (Identity Broker)
    participant Globus as Globus (Identity Provider)

    User-&gt;&gt;Keystone: Login to Openstack
    Keystone-&gt;&gt;Keycloak: Auth Request

    Keycloak-&gt;&gt;User: Prompt for provider selection
    User-&gt;&gt;Keycloak: Chooses "Login with Federated Identity"
    Keycloak-&gt;&gt;Globus: Auth Request
    User-&gt;&gt;Globus: Login to Globus

    Globus-&gt;&gt;Keycloak: Auth Response
    Note over Globus: includes username, id, display_name, email
    Keycloak-&gt;&gt;Keystone: Auth Response
    Note over Keycloak: Maps Globus Acct to Chameleon Acct
    Keystone-&gt;&gt;User: Login Permitted
    Note over Keystone: Maps Keycloak User, Projects to local ones
</div>
<p>Google, and ORCID logins are special casses of the globus login, and merely pre-fills a selection on the "login to globus" step. In contrast, "Log in with TAS" uses a Keycloak server at TACC as Identity Provider, instead of Globus.</p>
<p>Due to this delegation, keycloak need not hold any "password" for a user, since they only ever log in via an external identity source.</p>
<p>The chameleon portal is the mechanism by which projects are created and managed in keycloak, and in particular, we set a flag to indicate whether a given project has an active allocation.</p>
<p>Keycloak holds a unique "client" for each service provider, which includes portal, keystone at each site, and several other services which leverage SSO (Jupyterhub, grafana,...).</p>
<p>We have added a custom "mapper" to Keycloak such that when one of these clients sends an auth request, keycloak responds with a list of projects that the user is a member of, <em>filtered for only ones with an active allocation</em>.</p>
<p>Keystone, when it receives a token with this list of projects, is configured to create a local project and user membership therein, updated at the time of login.</p>
<p><em>Note: if they never log in again, this means that users will remain in expired local projects indefinitely.</em></p>
<h2 id="issues-with-account-linking">Issues with Account Linking</h2>
<p>On first login, keycloak attempts to match the incoming identity from Globus or TAS with an existing Chameleon account, and does so by comparing the "primary id" from the provider, to the "linked identities" of the Chameleon accounts.</p>
<p>In the simple case, this all works well, and either a match is found, and the user logged in, or a match is not found, and a new account created.</p>
<p>However, we ran into issues where users would end up with N different globus accounts, and a unique chameleon account for each, and therefore would not have consistent project memebership or openstack resource ownership, depending on the federated identity used.</p>
<p>To address this, we added a check not just for the primary ID, but also the linked email address. In the case where an the primary ID does <em>not</em> match, but an email address does, the user is asked to separately authenticate to the matched identity to prove ownership, after which the linked identity is updated to the new one.</p>
<p>This works for TAS, but encounters multiple issues with Globus. </p>
<ol>
<li>The account linking mechanism for globus is prompting for the "password" of the other keycloak account, which may not have ever been set.</li>
<li>In globus, it is valid to have multiple different accounts with the same email address associated. <ol>
<li>Additionally, Globus accounts can either be completely independent, in which case they return unique primary identities to keycloak</li>
<li>or they can be "linked", in which case globus will return a single primary identity for all of them, but also include a list of linked identities.</li>
</ol>
</li>
<li>A user may not be aware of what globus identity they are authenticated.</li>
<li>the identity we map from keycloak -&gt; Keystone is the globus "username", but this is not a guaranteed stable identifier, and may change over time.</li>
</ol>
<p>Ultimately, we should implement some or all of the following:</p>
<ol>
<li>Display a users currently authenticated federated identity on the account linking screen</li>
<li>provide a mechanism to open a helpdesk ticket from the account linking page</li>
<li>permit use of email to validate linked accounts (but only verified emails)</li>
<li>take advantage of the list of identities that globus returns to match users more robustly, and direct users to the globus account linking</li>
</ol>
<h2 id="references">References</h2>
<ul>
<li><a href="https://docs.globus.org/api/auth/specification/#identities">Globus Identities</a></li>
<li><a href="https://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth">OpenID Auth Code Flow</a></li>
<li><a href="https://www.keycloak.org/docs/latest/server_admin/index.html#_identity_broker_overview">Keycloak ID Brokering</a></li>
<li><a href="https://chameleoncloud.org/media/filer_public/8e/a5/8ea5bbb8-5b21-4ee7-a29c-3063afef7751/pearc22-federated-identity.pdf">Migrating towards Single Sign-On and Federated Identity</a></li>
</ul>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["content.action.edit", "content.action.view", "content.code.copy", "navigation.sections", "navigation.expand"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
mermaid.initialize({});</script></body>
</html>